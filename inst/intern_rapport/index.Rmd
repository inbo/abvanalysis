---
title: "Indices van de Algemene Broedvogelsmonitoring Vlaanderen (ABV)"
author:
  -
    name: "Thierry Onkelinx"
    email: "thierry.onkelinx@inbo.be"
  -
    name: "Glenn Vermeersch"
    email: "glenn.vermeersch@inbo.be"
reportnr: "Hier komt de DOI van het rapport"
link-citations: TRUE
site: bookdown::bookdown_site
output:
  bookdown::pdf_book:
    base_format: INBOmd::inbo_rapport
    floatbarrier: subsubsection
    lang: dutch
    lof: FALSE
    lot: FALSE
    tocdepth: 2
  bookdown::gitbook:
    split_by: "chapter+number"
    template: !expr INBOmd::inbo_rapport_css("html")
  bookdown::epub_book:
    stylesheet: "css/inbo_rapport.css"
    template: !expr INBOmd::inbo_rapport_css("epub")
params:
  username: !r Sys.getenv("N2KRESULT_USERNAME")
  password: !r Sys.getenv("N2KRESULT_PASSWORD")
---

```{r setup, results ='hide', echo = FALSE, message = FALSE, cache = FALSE, purl = FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  cache = FALSE,
  dpi = 300,
  fig.width = 150 / 25.4,
  fig.height = 75 / 25.4,
  warning = FALSE,
  error = TRUE,
  message = FALSE
)
library(n2khelper)
library(tidyverse)
library(scales)
library(effectclass)
library(INBOtheme)
grenzen <- c(0.65, 1.5)
theme_set(
  theme_inbo(
    base_family = "Flanders Art Sans",
    base_size = 12
  )
)
if (!interactive() && opts_knit$get("rmarkdown.pandoc.to") == "latex") {
  opts_chunk$set(dev = "cairo_pdf")
  theme_set(
    theme_inbo(
      base_family = "Flanders Art Sans",
      base_size = 8
    )
  )
}
index_breaks <- function(x) {
  z <- 1 - c(
    9 / 10, 4 / 5, 3 / 4, 2 / 3, 1 / 2, 1 / 3, 1 / 4, 1 / 5, 1 / 10, 1 / 20,
    1 / 50, 1 / 100, 1 / 200, 0
  )
  z <- log(sort(z))
  z <- z[which(z >= min(-abs(x)))[1] + -1:2]
  c(z, 0, -z)
}
index_labels <- function(x) {
  sprintf("%+.0f%%", 100 * (exp(x) - 1))
}
```

```{r import-data}
conn <- connect_result(username = params$username, password = params$password)
tbl(conn, "scheme") %>%
  filter(description == "Algemene broedvogels") %>%
  semi_join(
    x = tbl(conn, "species_group"),
    by = c("scheme" = "id")
  ) %>%
  select(fingerprint, species_group = description) %>%
  collect() -> species_group
if (file.exists("results.rds")) {
  raw_results <- readRDS("results.rds")
} else {
  raw_results <- aws.s3::s3readRDS(
    file.path("abv", "results", "results.rds", fsep = "/"),
    bucket = "n2kmonitoring"
  )
  saveRDS(raw_results, "results.rds")
}
```

```{r}
raw_results %>%
  map_df("result") %>%
  right_join(x = species_group, by = c("fingerprint" = "species_group")) %>%
  mutate(
    composite = grepl("composite", model_type),
    cycle = grepl("(Cycle|cycle)", model_type),
    nonlinear = grepl("(RW1|non linear)", model_type)
  ) -> resultaten
```

```{r}
resultaten %>%
  distinct(stratum) %>%
  pull(stratum) -> strata
tbl(conn, "location") %>%
  filter(fingerprint %in% strata) %>%
  select(fingerprint, description) %>%
  collect() -> strata_description
strata_description %>%
  left_join(x = resultaten, by = c("stratum" = "fingerprint")) %>%
  mutate(
    stratum = ifelse(is.na(description), stratum, description)
  ) %>%
  select(-description) -> resultaten
```

# Samengestelde indices

```{r samengesteld, results='asis', cache = FALSE, eval = FALSE}
resultaten %>%
  filter(
    composite,
    grepl("non linear", model_type),
    grepl(" - ", parameter)
  ) -> composite_indices
composite_indices %>%
  distinct(fingerprint, species_group) %>%
  arrange(species_group) %>%
  pull(fingerprint) %>%
  sapply(
    function(id) {
      knit_expand("_samengesteld.Rmd", id = id)
    }
  ) %>%
  paste(collapse = "\n\n") -> rmd
knit(text = rmd, quiet = TRUE) %>%
  cat()
```


# Indices per soort

```{r indices, results='asis', cache = FALSE}
resultaten %>%
  filter(!composite) %>%
  distinct(fingerprint, species_group) %>%
  arrange(species_group) %>%
  pull(fingerprint) %>%
  sapply(
    function(id) {
      knit_expand("_soort_index.Rmd", id = id)
    }
  ) %>%
  paste(collapse = "\n\n") -> rmd
knit(text = rmd, quiet = TRUE) %>%
  cat()
```
