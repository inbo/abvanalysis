```{r {{id}}-set}
if (interactive()) {
  resultaten$meta %>%
    filter(composite) %>%
    sample_n(1) %>%
    pull(hash) -> id
} else {
  id <- "{{id}}"
}
```

```{r {{id}}-basis}
resultaten$meta %>%
  filter(hash == id) %>%
  slice(1) %>%
  pull(species_group) -> soort_naam
composite_soort %>%
  filter(hash == id) %>%
  arrange(soort) %>%
  mutate(
    soort = tolower(soort) %>%
      str_replace_all(" ", "-") %>%
      str_remove_all("'") %>%
      sprintf(fmt = "[%2$s](#soort-%1$s)", soort)
  ) %>%
  pull(soort) -> deze_soorten
deze_threshold <- log(0.75) / sqrt(length(deze_soorten))
wijziging %>%
  filter(hash == id) %>%
  mutate(
    schatting = exp(log_mean),
    log_lcl90 = qnorm(0.05, log_mean, log_sd),
    log_ucl90 = qnorm(0.95, log_mean, log_sd),
    lcl90 = exp(qnorm(0.05, log_mean, log_sd)),
    ucl90 = exp(qnorm(0.95, log_mean, log_sd)),
    lcl60 = exp(qnorm(0.2, log_mean, log_sd)),
    ucl60 = exp(qnorm(0.8, log_mean, log_sd)),
    lcl30 = exp(qnorm(0.35, log_mean, log_sd)),
    ucl30 = exp(qnorm(0.65, log_mean, log_sd)),
    klasse = classification(log_lcl90, log_ucl90, deze_threshold),
    wijziging = sprintf(
      "%s: %s t.o.v. %s (%s)", 
       ifelse(
        frequentie == "jaarlijks", 
        naar, 
        paste(naar, naar + 2, sep = "-")
      ),
      format_ci(
        exp(log_mean) - 1, lcl = exp(log_lcl90) - 1, ucl = exp(log_ucl90) - 1, 
        percent = TRUE, sign = TRUE
      ),
       ifelse(
        frequentie == "jaarlijks", 
        referentie, 
        paste(referentie, referentie + 2, sep = "-")
      ),
      klasse
    )
  ) -> deze_wijziging
```

# `r sprintf("%s {#index-%s}", soort_naam, soort_naam)`

Deze indicator is gebaseerd op volgende soorten: `r paste(deze_soorten, collapse = ", ")`.
De indicator bestaat uit `r length(deze_soorten)` soorten.
De aangepaste grenswaarden zijn `r sprintf("%+.1f%%", exp(deze_threshold) * 100 - 100)` en `r sprintf("%+.1f%%", exp(-deze_threshold) * 100 - 100)`.

(ref:{{id}}-index) Wijzigingen t.o.v. de start van het meetnet voor `r soort_naam`. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen en §\@ref(s:trendklasse) voor uitleg over de symbolen en referentielijnen.

```{r {{id}}-wijziging-jaar, fig.cap = "(ref:{{id}}-index)", eval = nrow(deze_wijziging) > 0, warning = FALSE}
deze_wijziging %>%
  filter(frequentie == "jaarlijks") %>%
  mutate(klasse = factor(klasse, levels = c(levels(klasse), "R"))) %>%
  complete(referentie, naar, fill = list(klasse = "R", schatting = 1)) %>%
  filter(referentie < max(referentie)) %>%
  mutate(
    periode = naar,
    naar_0 = naar - 0.5,
    naar_1 = naar + 0.5,
    interpretatie = recode(
      klasse, "++" = "sterke toename", "+" = "toename", "+~" = "matige toename",
      "~" = "stabiel", "-~" = "matige afname", "-" = "afname",
      "--" = "sterke afname", "?+" = "mogelijke toename",
      "?-" = "mogelijke afname", "?" = "onduidelijk", "R" = "referentie"
    )
  ) %>%
  mutate_at(
    c("schatting", "lcl90", "ucl90", "lcl60", "ucl60", "lcl30", "ucl30"), log
  ) %>%
  mutate(
    alpha_punt = ifelse(naar < referentie, 0, 1),
    alpha_vlak = ifelse(naar < referentie, 0, 0.3),
    klasse = ifelse(naar < referentie, NA, as.character(klasse))
  ) -> jaarlijks
if (!interactive() && opts_knit$get("rmarkdown.pandoc.to") != "html") {
  jaarlijks %>%
    filter(referentie == 2007) -> jaarlijks
}
p <- ggplot(
  jaarlijks,
  aes(
    x = naar, xmin = naar_0, xmax = naar_1, y = schatting, frame = referentie,
    periode = periode, wijziging = wijziging, interpretatie = interpretatie
  )
) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = deze_threshold * c(-1, 1), linetype = 2) +
  geom_rect(
    aes(ymin = lcl90, ymax = ucl90, fill = klasse),
    alpha = jaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl60, ymax = ucl60, fill = klasse),
    alpha = jaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl30, ymax = ucl30, fill = klasse),
    alpha = jaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_point(size = 6, alpha = jaarlijks$alpha_punt) +
  geom_text(
    aes(label = klasse),
    hjust = 0.5, vjust = 0.5, colour = "white"
  ) +
  scale_y_continuous(
    "procentuele wijziging t.o.v. referentieperiode", breaks = index_breaks,
    labels = index_labels
  ) +
  scale_fill_manual(values = kleurgradient) +
  theme(axis.title.x = element_blank())
if (interactive() || opts_knit$get("rmarkdown.pandoc.to") == "html") {
  ggplotly(
    p,
    tooltip = c("referentie", "periode", "wijziging", "interpretatie")
  ) %>%
    animation_opts(frame = 1000, transition = 0, redraw = TRUE) %>%
    animation_slider(
      font = list(color = "black"),
      currentvalue = list(
        prefix = "geselecteerd referentiejaar: ",
        font = list(color = inbo_hoofd), xanchor = "center"
      )
    ) %>%
    animation_button(label = "\u25B6") %>%
    layout(showlegend = FALSE) %>%
    plotly::config(
      modeBarButtonsToRemove = list(
        "lasso2d", "select2d", "autoScale2d", "hoverClosestCartesian",
        "hoverCompareCartesian", "toggleSpikelines"
      ),
      displaylogo = FALSE
    )
} else {
  p
}
```

(ref:{{id}}-index-cyclus) Wijzigingen per driejarige cyclus voor `r soort_naam`. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen en §\@ref(s:trendklasse) voor uitleg over de symbolen en referentielijnen.

```{r {{id}}-wijziging-cyclus, fig.cap = "(ref:{{id}}-index-cyclus)", eval = nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(frequentie == "driejaarlijks") %>%
  mutate(klasse = factor(klasse, levels = c(levels(klasse), "R"))) %>%
  complete(referentie, naar, fill = list(klasse = "R", schatting = 1)) %>%
  filter(referentie < max(referentie)) %>%
  mutate(
    naar_0 = naar - 1.5,
    naar_1 = naar + 1.5,
    interpretatie = recode(
      klasse, "++" = "sterke toename", "+" = "toename", "+~" = "matige toename",
      "~" = "stabiel", "-~" = "matige afname", "-" = "afname",
      "--" = "sterke afname", "?+" = "mogelijke toename",
      "?-" = "mogelijke afname", "?" = "onduidelijk", "R" = "referentie"
    )
  ) %>%
  mutate_at(
    c("schatting", "lcl90", "ucl90", "lcl60", "ucl60", "lcl30", "ucl30"), log
  ) %>%
  mutate(
    alpha_punt = ifelse(naar < referentie, 0, 1),
    alpha_vlak = ifelse(naar < referentie, 0, 0.3),
    klasse = ifelse(naar < referentie, " ", as.character(klasse)),
    wijziging = ifelse(naar == referentie, "n.v.t.", wijziging),
    referentie = periode_labels(referentie),
    periode = periode_labels(naar)
  ) -> driejaarlijks
if (!interactive() && opts_knit$get("rmarkdown.pandoc.to") != "html") {
  driejaarlijks %>%
    filter(referentie == "2007 - 2009") -> driejaarlijks
}
p <- ggplot(
  driejaarlijks,
  aes(
    x = naar, xmin = naar_0, xmax = naar_1, y = schatting, frame = referentie,
    periode = periode, wijziging = wijziging, interpretatie = interpretatie
  )
) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = deze_threshold * c(-1, 1), linetype = 2) +
  geom_rect(
    aes(ymin = lcl90, ymax = ucl90, fill = klasse),
    alpha = driejaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl60, ymax = ucl60, fill = klasse),
    alpha = driejaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl30, ymax = ucl30, fill = klasse),
    alpha = driejaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_point(size = 6, alpha = driejaarlijks$alpha_punt) +
  geom_text(
    aes(label = klasse), hjust = 0.5, vjust = 0.5, colour = "white"
  ) +
  scale_x_continuous(
    breaks = unique(driejaarlijks$naar), labels = periode_labels
  ) +
  scale_y_continuous(
    "procentuele wijziging t.o.v. referentieperiode", breaks = index_breaks,
    labels = index_labels
  ) +
  scale_fill_manual(values = kleurgradient) +
  theme(axis.title.x = element_blank())
if (interactive() || opts_knit$get("rmarkdown.pandoc.to") == "html") {
  ggplotly(
    p,
    tooltip = c("referentie", "periode", "wijziging", "interpretatie")
  ) %>%
    animation_opts(frame = 1000, transition = 0, redraw = TRUE) %>%
    animation_button(label = "\u25B6") %>%
    animation_slider(
      len = 0.9, font = list(color = "black"),
      currentvalue = list(
        prefix = "geselecteerd referentieperiode: ",
        font = list(color = inbo_hoofd), xanchor = "center"
      )
    ) %>%
    layout(showlegend = FALSE) %>%
    plotly::config(
      modeBarButtonsToRemove = list(
        "lasso2d", "select2d", "autoScale2d", "hoverClosestCartesian",
        "hoverCompareCartesian", "toggleSpikelines"
      ),
      displaylogo = FALSE
    )
} else {
  p
}
```


(ref:{{id}}-raster3) Paarsgewijze vergelijking tussen driejarige cycli voor `r soort_naam`.

```{r {{id}}-wijziging-jaar-alles3, fig.cap = "(ref:{{id}}-raster3)", eval = output_format != "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(frequentie == "driejaarlijks") %>%
  ggplot(aes(x = naar, y = referentie, label = klasse)) +
  geom_point(aes(colour = klasse), size = 6, show.legend = FALSE) +
  scale_colour_manual(values = kleurgradient) +
  geom_text(
    aes(label = klasse),
    hjust = 0.5, vjust = 0.5, colour = "white"
  ) +
  scale_x_continuous(
    breaks = function(x) {seq(2007, x[2], by = 3)},
    labels = function(x) {sprintf("%02i-%02i", x, x + 2)}
  ) +
  scale_y_continuous(
    breaks = function(x) {seq(2007, x[2], by = 3)},
    labels = function(x) {sprintf("%02i-%02i", x, x + 2)}
  ) +
  coord_fixed() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

(ref:{{id}}-raster) Paarsgewijze vergelijking tussen jaren voor `r soort_naam`.

```{r {{id}}-wijziging-jaar-alles2, fig.cap = "(ref:{{id}}-raster)", eval = output_format != "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(frequentie == "jaarlijks") %>%
  ggplot(aes(x = naar, y = referentie, label = klasse)) +
  geom_point(aes(colour = klasse), size = 4, show.legend = FALSE) +
  scale_colour_manual(values = kleurgradient) +
  geom_text(
    aes(label = klasse), hjust = 0.5, vjust = 0.5, colour = "white", size = 2
  ) +
  coord_fixed() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

(ref:{{id}}-hash) Data-hashes van de analyse in het kader van traceerbaarheid (zie §\@ref(s:traceerbaarheid)).

```{r {{id}}-hash, results = "asis"}
resultaten$meta %>%
  filter(hash == id, nonlinear) %>%
  arrange(cycle) %>%
  transmute(
    frequentie = factor(
      cycle, 
      levels = c(TRUE, FALSE), 
      labels = c("driejaarlijks", "jaarlijks")
    ),
    analyse = str_replace(analysis, "(.{20})", "\\1 "), 
    status = str_replace(status, "(.{20})", "\\1 ")
  ) %>%
  pandoc.table(caption = "(ref:{{id}}-hash)")
```
