```{r {{id}}-set}
if (interactive()) {
  resultaten$meta %>%
    sample_n(1) %>%
    pull(hash) -> id
} else {
  id <- "{{id}}"
}
```

```{r {{id}}-basis}
if (sum(aantal$hash == id) == 0) {
  dit_aantal <- data.frame()
  deze_wijziging <- data.frame(cycle = logical(0))
  titel <- ""
} else {
  aantal %>%
    filter(hash == id) %>%
    mutate(
      text_median = sprintf(
        sprintf(
          "%%i %1$s (%1$s; %1$s)", 
          sprintf("%%.%if", 1 - floor(log10(min(lcl90))))),
          parameter, median, lcl90, ucl90
      )
    ) -> dit_aantal
  wijziging %>%
    filter(hash == id) -> deze_wijziging
  resultaten$meta %>%
    filter(hash == id) %>%
    slice(1) %>%
    pull(species_group) -> soort_naam
  lineair %>%
    filter(hash == id) -> deze_lineair
  stratum_gewicht %>%
    filter(hash == id) -> dit_stratum
  tolower(soort_naam) %>% 
    str_replace_all(" ", "-") %>% 
    str_remove_all("'") %>%
    sprintf(fmt = "# %2$s {#soort-%1$s}", soort_naam) -> titel
}
```

`r titel`

Op basis van driejaarlijkse gegevens zien we gemiddeld `r deze_lineair$tekst[deze_lineair$frequentie == "driejaarlijks"]` `r deze_lineair$jaarlijks[deze_lineair$frequentie == "driejaarlijks"]` per jaar of `r deze_lineair$looptijd[deze_lineair$frequentie == "driejaarlijks"]` over de volledige looptijd van het meetnet.
Deze trend is `r deze_lineair$interpretatie[deze_lineair$frequentie == "driejaarlijks"]`.

Op basis van jaarlijkse gegevens zien we gemiddeld `r deze_lineair$tekst[deze_lineair$frequentie == "jaarlijks"]` `r deze_lineair$jaarlijks[deze_lineair$frequentie == "jaarlijks"]` per jaar of `r deze_lineair$looptijd[deze_lineair$frequentie == "jaarlijks"]` over de volledige looptijd van het meetnet.
Deze trend is `r deze_lineair$interpretatie[deze_lineair$frequentie == "jaarlijks"]`.

(ref:{{id}}-aantal) Evolutie van het gemodeleerde gemiddeld aantal waargenomen dieren op een meetpunt voor `r soort_naam` tijdens de referentieperiode. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen.

```{r {{id}}-aantal, fig.cap = "(ref:{{id}}-aantal)", eval = output_format == "html" && nrow(dit_aantal) > 0, warning = FALSE}
dit_aantal %>%
  filter(!cycle) -> aantal_jaar
dit_aantal %>%
  filter(cycle) %>%
  transmute(parameter, low = lcl90, high = ucl90, level = 90) %>%
  bind_rows(
    dit_aantal %>%
      filter(cycle) %>%
      transmute(parameter, low = lcl60, high = ucl60, level = 60),
    dit_aantal %>%
      filter(cycle) %>%
      transmute(parameter, low = lcl30, high = ucl30, level = 30)
  ) %>%
  mutate(
    id = interaction(parameter, level)
  ) -> poly_cyclus
bind_rows(
  transmute(poly_cyclus, id, x = parameter - 1.4, y = low, level),
  transmute(poly_cyclus, id, x = parameter + 1.4, y = low, level),
  transmute(poly_cyclus, id, x = parameter + 1.4, y = high, level),
  transmute(poly_cyclus, id, x = parameter - 1.4, y = high, level)
) %>%
  group_by(id) -> poly_cyclus
dit_aantal %>%
  filter(cycle) %>%
  transmute(parameter, label = sprintf("%i-%i", parameter, parameter + 2)) -> 
  cyclus_labs
updatemenus <- list(
  list(
    active = 1,
    showactive = FALSE, 
    type = "dropdown",
    y = 1.2,
    buttons = list(
      list(
        label = "Driejaarlijks",
        method = "update",
        args = list(
          list(visible = c(FALSE, TRUE)),
          list(
            xaxis = list(
              tickvals = cyclus_labs$parameter,
              ticktext = cyclus_labs$label
            )
          )
        )
      ),
      list(
        label = "Jaarlijks",
        method = "update",
        args = list(
          list(visible = c(TRUE, FALSE)),
          list(
            xaxis = list(tick0 = 2007)
          )
        )
      )
    )
  )
)
plot_ly(
  fillcolor = inbo_steun_blauw, opacity = 0.3, showlegend = FALSE, 
  hoverinfo = "none"
) %>%
  add_ribbons(
    data = aantal_jaar, x = ~parameter, ymin = ~lcl90, ymax = ~ucl90, 
    line = list(width = 0)
  ) %>%
  add_polygons(
    data = filter(poly_cyclus, level == 90),
    x = ~x, y = ~y, line = list(width = 0), visible = FALSE
  ) %>%
  add_ribbons(
    data = aantal_jaar, x = ~parameter, ymin = ~lcl60, ymax = ~ucl60, 
    line = list(width = 0)
  ) %>%
  add_polygons(
    data = filter(poly_cyclus, level == 60),
    x = ~x, y = ~y, line = list(width = 0), visible = FALSE
  ) %>%
  add_ribbons(
    data = aantal_jaar, x = ~parameter, ymin = ~lcl30, ymax = ~ucl30, 
    line = list(width = 0)
  ) %>%
  add_polygons(
    data = filter(poly_cyclus, level == 30),
    x = ~x, y = ~y, line = list(width = 0), visible = FALSE
  ) %>%
  add_lines(
    data = aantal_jaar, x = ~parameter, y = ~median,
    line = list(color = inbo_steun_blauw, width = 4), 
    text = ~hover, hoverinfo = "text"
  ) %>%
  add_lines(
    data = dit_aantal %>%
      filter(cycle) %>%
      transmute(parameter, median, hover, start = -1.4, mid = 0, end = 1.4) %>%
      pivot_longer(c("start", "mid", "end")) %>%
      mutate(x = parameter + value) %>%
      group_by(parameter),
    x = ~x, y = ~median, text = ~hover, hoverinfo = "text", 
    line = list(color = inbo_steun_blauw, width = 4), visible = FALSE
  ) %>%
  layout(
    updatemenus = updatemenus,
    xaxis = list(
      title = "",
      tickvals = cyclus_labs$parameter,
      ticktext = cyclus_labs$label
    ),
    yaxis = list(
      title = "gemiddeld aantal dieren per meetpunt",
      range = range(pretty(c(0, max(dit_aantal$ucl90))))
    ),
    title = soort_naam,
    hoverlabel = list(
      bgcolor = inbo_lichtblauw,
      bordercolor = inbo_steun_blauw
    )
  ) %>%
  config(
    modeBarButtonsToRemove = list(
      "lasso2d", "select2d", "autoScale2d", "hoverClosestCartesian", 
      "hoverCompareCartesian", "toggleSpikelines"
    ),
    displaylogo = FALSE
  )
```

```{r {{id}}-aantal3, fig.cap = "(ref:{{id}}-aantal)", eval = output_format != "html" && nrow(dit_aantal) > 0, warning = FALSE}
dit_aantal %>%
  filter(cycle) %>%
  mutate(
    parameter = factor(
      parameter,
      levels = sort(unique(parameter)),
      labels = sprintf(
        "%i-%i", 
        sort(unique(parameter)), 
        sort(unique(parameter)) + 2
      )
    )
  ) %>%
  ggplot(aes(x = parameter, y = exp(log_mean), link_sd = log_sd)) +
  stat_fan(link = "log", geom = "rect") +
  geom_point() +
  scale_y_continuous(
    "gemiddeld aantal dieren per meetpunt", 
    limits = c(0, NA)
  ) +
  theme(axis.title.x = element_blank())
```

```{r {{id}}-aantal2, fig.cap = "(ref:{{id}}-aantal)", eval = output_format != "html" && nrow(dit_aantal) > 0, warning = FALSE}
dit_aantal %>%
  filter(!cycle) %>%
  ggplot(aes(x = parameter, y = exp(log_mean), link_sd = log_sd)) +
  stat_fan(link = "log") +
  geom_line() +
  scale_x_continuous(breaks = pretty) +
  scale_y_continuous(
    "gemiddeld aantal dieren per meetpunt", 
    limits = c(0, NA)
  ) +
  theme(axis.title.x = element_blank())
```

(ref:{{id}}-index) Wijzigingen tussen jaren voor `r soort_naam`. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen en §\@ref(s:trendklasse) voor uitleg over de symbolen en referentielijnen.

```{r {{id}}-wijziging-jaar, fig.cap = "(ref:{{id}}-index)", eval = nrow(dit_aantal) > 0, warning = FALSE}
deze_wijziging %>%
  filter(!cycle) %>%
  mutate(klasse = factor(klasse, levels = c(levels(klasse), "R"))) %>%
  complete(referentie, naar, fill = list(klasse = "R", schatting = 1)) %>%
  filter(referentie < max(referentie)) %>%
  mutate(
    periode = naar,
    naar_0 = naar - 0.5,
    naar_1 = naar + 0.5,
    interpretatie = recode(
      klasse, "++" = "sterke toename", "+" = "toename", "+~" = "matige toename",
      "~" = "stabiel", "-~" = "matige afname", "-" = "afname",
      "--" = "sterke afname", "?+" = "mogelijke toename",
      "?-" = "mogelijke afname", "?" = "onduidelijk", "R" = "referentie"
    )
  ) %>%
  mutate_at(
    c("schatting", "lcl90", "ucl90", "lcl60", "ucl60", "lcl30", "ucl30"), log
  ) %>%
  mutate(
    alpha_punt = ifelse(naar < referentie, 0, 1),
    alpha_vlak = ifelse(naar < referentie, 0, 0.3),
    klasse = ifelse(naar < referentie, NA, as.character(klasse))
  ) -> jaarlijks
if (!interactive() && opts_knit$get("rmarkdown.pandoc.to") != "html") {
  jaarlijks %>%
    filter(referentie == 2007) -> jaarlijks
}
p <- ggplot(
  jaarlijks,
  aes(
    x = naar, xmin = naar_0, xmax = naar_1, y = schatting, frame = referentie,
    periode = periode, wijziging = wijziging, interpretatie = interpretatie
  )
) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = log(0.75) * c(-1, 1), linetype = 2) +
  geom_rect(
    aes(ymin = lcl90, ymax = ucl90, fill = klasse),
    alpha = jaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl60, ymax = ucl60, fill = klasse),
    alpha = jaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl30, ymax = ucl30, fill = klasse),
    alpha = jaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_point(size = 6, alpha = jaarlijks$alpha_punt) +
  geom_text(
    aes(label = klasse),
    hjust = 0.5, vjust = 0.5, colour = "white"
  ) +
  scale_y_continuous(
    "procentuele wijziging t.o.v. referentieperiode", breaks = index_breaks,
    labels = index_labels
  ) +
  scale_fill_manual(values = kleurgradient) +
  theme(axis.title.x = element_blank())
if (interactive() || opts_knit$get("rmarkdown.pandoc.to") == "html") {
  ggplotly(
    p,
    tooltip = c("referentie", "periode", "wijziging", "interpretatie")
  ) %>%
    animation_opts(frame = 1000, transition = 0, redraw = TRUE) %>%
    animation_slider(
      font = list(color = "black"),
      currentvalue = list(
        prefix = "geselecteerd referentiejaar: ",
        font = list(color = inbo_hoofd), xanchor = "center"
      )
    ) %>%
    animation_button(label = "\u25B6") %>%
    layout(showlegend = FALSE) %>%
    plotly::config(
      modeBarButtonsToRemove = list(
        "lasso2d", "select2d", "autoScale2d", "hoverClosestCartesian",
        "hoverCompareCartesian", "toggleSpikelines"
      ),
      displaylogo = FALSE
    )
} else {
  p
}
```

(ref:{{id}}-index3) Wijzigingen per driejarige cyclus voor `r soort_naam`. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen en §\@ref(s:trendklasse) voor uitleg over de symbolen en referentielijnen.

```{r {{id}}-wijziging-cyclus, fig.cap = "(ref:{{id}}-index3)", eval = nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(cycle) %>%
  mutate(klasse = factor(klasse, levels = c(levels(klasse), "R"))) %>%
  complete(referentie, naar, fill = list(klasse = "R", schatting = 1)) %>%
  filter(referentie < max(referentie)) %>%
  mutate(
    naar_0 = naar - 1.5,
    naar_1 = naar + 1.5,
    interpretatie = recode(
      klasse, "++" = "sterke toename", "+" = "toename", "+~" = "matige toename",
      "~" = "stabiel", "-~" = "matige afname", "-" = "afname",
      "--" = "sterke afname", "?+" = "mogelijke toename",
      "?-" = "mogelijke afname", "?" = "onduidelijk", "R" = "referentie"
    )
  ) %>%
  mutate_at(
    c("schatting", "lcl90", "ucl90", "lcl60", "ucl60", "lcl30", "ucl30"), log
  ) %>%
  mutate(
    alpha_punt = ifelse(naar < referentie, 0, 1),
    alpha_vlak = ifelse(naar < referentie, 0, 0.3),
    klasse = ifelse(naar < referentie, " ", as.character(klasse)),
    wijziging = ifelse(naar == referentie, "n.v.t.", wijziging),
    referentie = periode_labels(referentie),
    periode = periode_labels(naar)
  ) -> driejaarlijks
if (!interactive() && opts_knit$get("rmarkdown.pandoc.to") != "html") {
  driejaarlijks %>%
    filter(referentie == "2007 - 2009") -> driejaarlijks
}
p <- ggplot(
  driejaarlijks,
  aes(
    x = naar, xmin = naar_0, xmax = naar_1, y = schatting, frame = referentie,
    periode = periode, wijziging = wijziging, interpretatie = interpretatie
  )
) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = deze_threshold * c(-1, 1), linetype = 2) +
  geom_rect(
    aes(ymin = lcl90, ymax = ucl90, fill = klasse),
    alpha = driejaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl60, ymax = ucl60, fill = klasse),
    alpha = driejaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_rect(
    aes(ymin = lcl30, ymax = ucl30, fill = klasse),
    alpha = driejaarlijks$alpha_vlak, show.legend = FALSE
  ) +
  geom_point(size = 6, alpha = driejaarlijks$alpha_punt) +
  geom_text(
    aes(label = klasse), hjust = 0.5, vjust = 0.5, colour = "white"
  ) +
  scale_x_continuous(
    breaks = unique(driejaarlijks$naar), labels = periode_labels
  ) +
  scale_y_continuous(
    "procentuele wijziging t.o.v. referentieperiode", breaks = index_breaks,
    labels = index_labels
  ) +
  scale_fill_manual(values = kleurgradient) +
  theme(axis.title.x = element_blank())
if (interactive() || opts_knit$get("rmarkdown.pandoc.to") == "html") {
  ggplotly(
    p,
    tooltip = c("referentie", "periode", "wijziging", "interpretatie")
  ) %>%
    animation_opts(frame = 1000, transition = 0, redraw = TRUE) %>%
    animation_button(label = "\u25B6") %>%
    animation_slider(
      len = 0.9, font = list(color = "black"),
      currentvalue = list(
        prefix = "geselecteerd referentieperiode: ",
        font = list(color = inbo_hoofd), xanchor = "center"
      )
    ) %>%
    layout(showlegend = FALSE) %>%
    plotly::config(
      modeBarButtonsToRemove = list(
        "lasso2d", "select2d", "autoScale2d", "hoverClosestCartesian",
        "hoverCompareCartesian", "toggleSpikelines"
      ),
      displaylogo = FALSE
    )
} else {
  p
}
```

(ref:{{id}}-raster2) Paarsgewijze vergelijking tussen jaren voor `r soort_naam`. Uitleg van de symbolen in tabel \@ref(tab:regels).

(ref:{{id}}-raster3) Paarsgewijze vergelijking tussen driejarige cycli voor `r soort_naam`. Uitleg van de symbolen in tabel \@ref(tab:regels).

```{r {{id}}-wijziging-jaar-alles3, fig.cap = "(ref:{{id}}-raster3)", eval = output_format != "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(cycle) %>%
  ggplot(aes(x = naar, y = referentie, label = klasse)) +
  geom_point(aes(colour = klasse), size = 6, show.legend = FALSE) +
  scale_colour_manual(values = kleurgradient) +
  geom_text(
    aes(label = klasse),
    hjust = 0.5, vjust = 0.5, colour = "white"
  ) +
  scale_x_continuous(
    breaks = function(x) {seq(2007, x[2], by = 3)},
    labels = function(x) {sprintf("%02i-%02i", x, x + 2)}
  ) +
  scale_y_continuous(
    breaks = function(x) {seq(2007, x[2], by = 3)},
    labels = function(x) {sprintf("%02i-%02i", x, x + 2)}
  ) +
  coord_fixed() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

```{r {{id}}-wijziging-jaar-alles2, fig.cap = "(ref:{{id}}-raster2)", eval = output_format != "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(!cycle) %>%
  ggplot(aes(x = naar, y = referentie, label = klasse)) +
  geom_point(aes(colour = klasse), size = 4, show.legend = FALSE) +
  scale_colour_manual(values = kleurgradient) +
  geom_text(
    aes(label = klasse), hjust = 0.5, vjust = 0.5, colour = "white", size = 2
  ) +
  coord_fixed() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

(ref:{{id}}-sg) Stratumgewicht, raming aan het aantal hokken waarin de soort aanwezig is, aantal relevant hokken voor de analyse, aantal onderzochte hokken in het stratum, totaal aantal hokken van het stratum in Vlaanderen en aantal bezoeken aan een meetpunt voor `r soort_naam` (zie §\@ref(s:stratumgewicht)).

```{r {{id}}-sd}
dit_stratum %>%
  select(-hash) %>%
  mutate(
    gewicht = sprintf("%.1f%%", 100 * gewicht),
    aanwezig = round(aanwezig, 1)
  ) %>%
  kable(caption = "(ref:{{id}}-sg)", align = "lrrrrrr")
```

(ref:{{id}}-hash) Data-hashes van de analyses in het kader van traceerbaarheid (zie §\@ref(s:traceerbaarheid)).

```{r {{id}}-hash, results = "asis"}
resultaten$meta %>%
  filter(hash == id) %>%
  arrange(cycle, nonlinear) %>%
  transmute(
    frequentie = factor(
      cycle, 
      levels = c(TRUE, FALSE), 
      labels = c("driejaarlijks", "jaarlijks")
    ),
    model = ifelse(nonlinear, "niet-lineair", "lineair"),
    analyse = str_replace(analysis, "(.{20})", "\\1 "), 
    status = str_replace(status, "(.{20})", "\\1 ")
  ) %>%
  pandoc.table(caption = "(\\#tab:{{id}}-hash) (ref:{{id}}-hash)")
```
