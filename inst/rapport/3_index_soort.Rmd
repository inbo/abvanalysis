# Indices per soort

In dit hoofdstuk geven we de trends voor de individuele soorten weer. Eerst geven we een samenvatting van de trends voor alle soorten. Vervolgens vatten we de informatie per soort samen in drie grafieken. Een eerste grafiek geeft de indices weer wanneer we ons baseren op de jaarlijkse gegevens. Een tweede grafiek geeft de indices na een aggregatie van de gegevens tot driejarige cycli. De derde grafiek geeft een overzicht van het aantal hokken, opgesplitst per jaar en per stratum, waarop de indices gebaseerd zijn. Tot slot geven we nog voor elk model de controlesommen weer voor de analyse en de status. Deze controlesommen laten toe om de reproduceerbaarheid van de verwerking te na te gaan. Aanpassing in de data zullen leiden tot een andere controlesom voor zowel de analyse als de status. Aanpassingen aan de berekeningwijze tussen enkel leiden tot een andere controlesom voor de status.

```{r}
species %>%
  distinct(parameter) %>%
  filter(grepl("^[[:digit:]]{4}$", parameter)) %>%
  mutate(parameter = as.integer(parameter)) %>%
  pull(parameter) %>%
  range() %>%
  diff() -> delta
species %>%
  distinct(species_group, cycle, non_linear, waic) %>%
  arrange(waic) %>%
  group_by(species_group, cycle) %>%
  mutate(waic = max(waic) - waic) %>%
  slice(1) %>%
  transmute(
    trend = ifelse(
      !non_linear | waic < 2,
      "L",
      ifelse(
        non_linear & waic > 5,
        "NL",
        "L?"
      )
    ),
    trend = factor(
      trend, 
      levels = c("L", "L?", "NL")
    )
  ) -> trend_type
threshold <- abs(log(0.5) / 15)
species %>%
  filter(parameter == "Trend") %>%
  mutate(
    indeling = ifelse(
      lcl > 0,
      ifelse(
        lcl > threshold, 
        "++", 
        ifelse(ucl < threshold, "+0", "+")
      ),
      ifelse(
        ucl < 0,
        ifelse(
          ucl < -threshold, 
          "--", 
          ifelse(lcl >- threshold, "-0", "-")
        ),
        ifelse(
          ucl < threshold,
          ifelse(lcl > -threshold, "0", "?-"),
          ifelse(lcl > -threshold, "?+", "?")
        )
      )
    )
  ) %>%
  inner_join(trend_type, by = c("species_group", "cycle")) %>%
  mutate(
    median = median * delta / ifelse(cycle, 3, 1),
    lcl = lcl * delta / ifelse(cycle, 3, 1),
    ucl = ucl * delta / ifelse(cycle, 3, 1)
  ) %>%
  transmute(
    soort = sprintf(
      "[%s](#soort-%s)",
      species_group,
      fingerprint,
      ifelse(cycle, "cyclus", "jaar")
    ),
    indeling, trend, cycle, median,
    wijziging = sprintf(
      "%+.0f%% (%+.0f%%; %+.0f%%)",
      100 * exp(median) - 100,
      100 * exp(lcl) - 100,
      100 * exp(ucl) - 100
    )
  ) -> trends
levels(trend_type$trend) <- c(
  "log-lineair", "mogelijk niet-lineair", "niet lineair"
)
species %>%
  inner_join(trend_type, by = c("species_group", "cycle")) -> species
```

## Overzicht van de trends

In deze sectie geven we een overzicht van de (log-)lineaire trend van alle soorten. Dit is de wijziging die we vaststellen over na een periode van `r delta` jaar na het startjaar. Dit komt overeen met de periode waarvan we beschikbare informatie hebben. Figuur \@ref(fig:voorbeeld-trend) illustreert welke totale wijziging overeenkomt met een vaste jaarlijkse wijziging van -5% of +5%.

```{r voorbeeld-trend, fig.cap = "Totale wijziging bij een vaste jaarlijkse wijziging"}
expand.grid(
  jaar = 0:15,
  trend = c(-0.05, 0.05)
) %>%
  mutate(
    wijziging = exp(log(1 + trend) * jaar) - 1,
    trend = sprintf("%i%%/jaar", 100 * trend)
  ) %>%
  ggplot(aes(x = jaar, y = wijziging, colour = trend)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_line() +
  scale_y_continuous(labels = percent)
```

Bij elke wijziging geven eveneens een indicatie van het type trend weer.

- **L**: De wijziging is constant over de volledige looptijd (een log-lineaire trend). De gerapportteerde wijziging is zinvol om te interpreteren.
- **L?**: De wijziging is mogelijk niet constant over de looptijd (een mogelijk niet lineaire trend). Interpreteer de gerapporteerde wijziging in combinatie met de trendgrafiek.
- **NL**: De wijziging is met zekerheid niet constant over de looptijd (een niet-lineaire trend). De aantallen van deze soort schommelen sterk tussen de jaren waardoor een totale wijzing altijd zinvol is. Interpreteer de wijzigingen enkel aan de hand van trendgrafiek.

De trends worden in 10 klassen ingedeeld op basis van onderstaande regels. Deze regels vergelijken de ligging van het betrouwbaarheidsinterval met drie waarden: de referentie, de ondergrens en de bovengrens. Als referentie gebruiken we 0%, m.a.w. geen wijziging. Als ondergrens voor de wijziging over `r delta` gebruiken we `r sprintf("%.1f%%", 100 * exp(-threshold * delta) - 100)`. Dit komt overeen met elke 15 jaar een halvering. Voor de bovengrens gebruiken we `r sprintf("%.1f%%", 100 * exp(threshold * delta) - 100)`, wat overeenkomst met elke 15 jaar een verdubbeling. Figuur \@ref(fig:trend-voorbeeld-fijn) illustreert deze regels aan de hand van voorbeelden.

- **sterke toename (++)**: de aantallen verdubbelen met zekerheid elke 15 jaar.
- **beperkte toenname (+≈)**: de aantallen met zekerheid toe en de toename is minder sterk van een verdubbling over 15.
- **toename (+)**: de aantallen met zekerheid toe. We hebben geen zekerheid of de toename al dan niet sterker is dan een verdubbeling over 15 jaar.
- **sterke afname (--)**: de aantallen halver met zekerheid elke 15 jaar.
- **beperkte afname (-≈)**: de aantallen met zekerheid af en de afname is minder sterk van een halvering over 15.
- **afname (-)**: de aantallen met zekerheid af. We hebben geen zekerheid of de afname al dan niet sterker is dan een halvering over 15 jaar.
- **stabiel (≈)**: een eventuele wijziging in de aantallen is met zekerheid minder sterk dan een verdubbeling of halvering over 15 jaar.
- **mogelijke toename (?+)**: we kunnen enkel met zekerheid stellen dan een eventuele afname niet sterker is dan een halvering over 15 jaar.
- **mogelijke afname (?-)**: we kunnen enkel met zekerheid stellen dan een eventuele toename niet sterker is dan een verdubbeling over 15 jaar.
- **onzekere trend (?)**: de onzekerheid op de wijziging is dermate groot dat zowel een verdubbeling als een halvering over 15 jaar plausibel zijn.

```{r trend-voorbeeld-fijn, fig.cap = "Voorbeelden van betrouwbaarheidsintervallen met hun indeling in 10 klassen.", fig.height = 100 / 25.4}
tribble(
  ~interpretatie, ~ondergrens, ~bovengrens, ~ymin, ~ymax, ~ruw,
  "--", -Inf, -0.05, 0.5, 1.5, "-",
  "-", -Inf, 0, 1.5, 2.5, "-",
  "-≈", -0.05, 0, 0.5, 1.5, "-",
  "≈", -0.05, 0.05, 2.5, 3.5, "≈",
  "+≈", 0, 0.05, 0.5, 1.5, "+",
  "+", 0, Inf, 1.5, 2.5, "+",
  "++", 0.05, Inf, 0.5, 1.5, "+",
  "?", -Inf, Inf, 5.5, 6.5, "?",
  "?-", -Inf, 0.05, 3.5, 4.5, "?",
  "?+", -0.05, Inf, 4.5, 5.5, "?"
) %>%
  mutate(
    y = (ymin + ymax) / 2,
    interpretatie = factor(
      interpretatie, 
      levels = c("++", "+", "+≈", "≈", "-≈", "-", "--", "?+", "?", "?-")
    ),
    ruw = factor(ruw, levels = c("-", "≈", "+", "?"))
  ) -> interpretatie_grenzen
expand.grid(
  x = seq(-0.08, 0.08, by = 0.02),
  se = c(0.01, 0.03, 0.06)
) %>%
  mutate(
    logx = log(1 + x),
    ondergrens = exp(logx - 1.96 * se) - 1,
    bovengrens = exp(logx + 1.96 * se) - 1,
    interpretatie = ifelse(
      ondergrens > 0,
      ifelse(
        ondergrens > 0.05,
        "++",
        ifelse(
          bovengrens < 0.05,
          "+≈",
          "+"
        )
      ),
      ifelse(
        bovengrens < 0,
        ifelse(
          bovengrens < -0.05,
          "--",
          ifelse(
            ondergrens > -0.05,
            "-≈",
            "-"
          )
        ),
        ifelse(
          -0.05 < ondergrens,
          ifelse(bovengrens < 0.05, "≈", "?+"),
          ifelse(bovengrens < 0.05, "?-", "?")
        )
      )
    ),
    interpretatie = factor(
      interpretatie, 
      levels = levels(interpretatie_grenzen$interpretatie)
    ),
    group = interaction(se, x, interpretatie)
  ) %>%
  inner_join(
    interpretatie_grenzen %>%
      select(interpretatie, y, ruw), 
    by = "interpretatie"
  ) -> tweezijdig
groenen <- colorRampPalette(c(inbo.groen, "white"))(5)
roden <- colorRampPalette(c(inbo.rood, "white"))(5)
roodgrijs <- colorRampPalette(c(inbo.grijs, inbo.rood))(4)
groengrijs <- colorRampPalette(c(inbo.grijs, inbo.groen))(4)
ggplot(tweezijdig, aes(ymin = ondergrens, ymax = bovengrens)) +
  geom_rect(
    data = interpretatie_grenzen, 
    aes(xmin = ymin, xmax = ymax, fill = interpretatie)
  ) +
  geom_vline(
    xintercept = c(1.5, 2.5, 3.5, 5.5), 
    linetype = 4, 
    size = 0.5,
    colour = vl.black
  ) +
  geom_hline(
    yintercept = c(0, -0.05, 0.05), 
    linetype = c(2, 3, 3), 
    size = 0.5,
    colour = inbo.hoofd
  ) +
  geom_errorbar(
    aes(x = y, group = group), 
    position = position_dodge(width = 1)) +
  geom_point(
    aes(y = x, x = y, group = group), 
    position = position_dodge(width = 1)
  ) +
  scale_x_continuous(
    breaks = c(1, 2, 3, 4.5, 6), 
    labels = c("nauwkeurige\ntrend", "onnauwkeurige\ntrend", "stabiele\ntrend", "mogelijke\ntrend", "onzekere\ntrend")
  ) +
  scale_y_continuous(
    "wijziging",
    breaks = c(-0.05, 0, 0.05),
    labels = c("onder\ngrens", "referentie", "boven\ngrens")
  ) +
  scale_fill_manual(
    "indeling",
    values = c(
      "--" = roden[1],
      "-" = roden[2], 
      "-≈" = roden[3],
      "≈" = inbo.lichtgrijs,
      "+≈" = groenen[3],
      "+" = groenen[2],
      "++" = groenen[1],
      "?-" = roodgrijs[2],
      "?" = inbo.grijs,
      "?+" = groengrijs[2]
    )
  ) +
  theme(
    axis.title.x = element_blank()
  )
```


### Lineaire trends op basis van jaarlijkse gegevens

```{r trend-jaar-sterke-toename, results = "asis"}
trends %>%
  filter(!cycle, indeling == "++") %>%
  arrange(desc(median)) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een sterke toename op basis van jaarlijkse data.

```{r trend-jaar-beperkte-toename, results = "asis"}
trends %>%
  filter(!cycle, indeling == "+0") %>%
  arrange(desc(median)) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een beperkte toename op basis van jaarlijkse data.

```{r trend-jaar-toename, results = "asis"}
trends %>%
  filter(!cycle, indeling == "+") %>%
  arrange(desc(median)) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een toename op basis van jaarlijkse data.

```{r trend-jaar-beperkte-afname, results = "asis"}
trends %>%
  filter(!cycle, indeling == "-0") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een beperkte afname op basis van jaarlijkse data.

```{r trend-jaar-sterke-afname, results = "asis"}
trends %>%
  filter(!cycle, indeling == "--") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een sterke afname op basis van jaarlijkse data.
```{r trend-jaar-afname, results = "asis"}
trends %>%
  filter(!cycle, indeling == "-") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een afname op basis van jaarlijkse data.

```{r trend-jaar-mogelijk-toename, results = "asis"}
trends %>%
  filter(!cycle, indeling == "?+") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een mogelijke toename op basis van jaarlijkse data.

```{r trend-jaar-mogelijk-afname, results = "asis"}
trends %>%
  filter(!cycle, indeling == "?-") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een mogelijke afname op basis van jaarlijkse data.

```{r trend-jaar-stabiel, results = "asis"}
trends %>%
  filter(!cycle, indeling == "0") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een stabiele trend op basis van jaarlijkse data.

```{r trend-jaar-onzeker, results = "asis"}
trends %>%
  filter(!cycle, indeling == "?") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een onzekere trend op basis van jaarlijkse data.

### Lineaire trends na aggregatie per driejarige cyclus

```{r trend-cyclus-sterke-toename, results = "asis"}
trends %>%
  filter(cycle, indeling == "++") %>%
  arrange(desc(median)) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een sterke toename op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-beperkte-toename, results = "asis"}
trends %>%
  filter(cycle, indeling == "+0") %>%
  arrange(desc(median)) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een beperkte toename op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-toename, results = "asis"}
trends %>%
  filter(cycle, indeling == "+") %>%
  arrange(desc(median)) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een toename op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-beperkte-afname, results = "asis", eval = any(trends$cycle & trends$indeling == "-0")}
trends %>%
  filter(cycle, indeling == "-0") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
cat("Table: Soorten met een beperkte afname op basis van data geaggregeerd per driejarige cyclus.")
```

```{r trend-cyclus-sterke-afname, results = "asis"}
trends %>%
  filter(cycle, indeling == "--") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een sterke afname op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-afname, results = "asis"}
trends %>%
  filter(cycle, indeling == "-") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een afname op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-mogelijk-toename, results = "asis"}
trends %>%
  filter(cycle, indeling == "?+") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een mogelijke toename op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-mogelijk-afname, results = "asis"}
trends %>%
  filter(cycle, indeling == "?-") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een mogelijke afname op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-stabiel, results = "asis"}
trends %>%
  filter(cycle, indeling == "0") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een stabiele trend op basis van data geaggregeerd per driejarige cyclus.

```{r trend-cyclus-onzeker, results = "asis"}
trends %>%
  filter(cycle, indeling == "?") %>%
  arrange(median) %>%
  select(soort, wijziging, trend) %>%
  kable(format = "markdown")
```
Table: Soorten met een onzekere trend op basis van data geaggregeerd per driejarige cyclus.

```{r indices, results='asis', cache = FALSE}
species %>%
  distinct(fingerprint, species_group, cycle, non_linear) %>%
  count(species_group, fingerprint) %>%
  filter(n == 4) %>%
  pull(fingerprint) %>%
  sapply(
    function(id) {
      knit_expand("_soort_index.Rmd", id = id)
    }
  ) %>%
  paste(collapse = "\n\n") -> rmd
knit(text = rmd, quiet = TRUE) %>%
  cat()
```
